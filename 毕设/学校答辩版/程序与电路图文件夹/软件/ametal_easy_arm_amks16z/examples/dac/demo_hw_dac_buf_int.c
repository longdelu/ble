/*******************************************************************************
*                                 AMetal
*                       ---------------------------
*                       innovating embedded systems
*
* Copyright (c) 2001-2015 Guangzhou ZHIYUAN Electronics Stock Co., Ltd.
* All rights reserved.
*
* Contact information:
* web site:    http://www.zlg.cn/
* e-mail:      ametal.support@zlg.cn
*******************************************************************************/

/**
 * \file
 * \brief DAC数模转换例程，通过HW接口实现
 *
 * - 实验现象：
 *   1. 配置PIOE_30为DAC模拟输出
 *   2. 用示波器采集数模转换的输出口PE30的信号输出
 *   3. 示波器显示PIOE_30的模拟输出为频率为200HZ的正弦波。
 *
 *
 * \par 源代码
 * \snippet demo_hw_dac_buf_int.c src_hw_dac_buf_int
 *
 * \internal
 * \par Modification History
 * - 1.00 15-10-22  xym, first implementation.
 * \endinternal
 */
 
/**
 * \addtogroup demo_if_hw_dac_buf_int
 * \copydoc demo_hw_dac_buf_int.c
 */
 
 /** [src_hw_dac_buf_int] */
#include "ametal.h"
#include "am_board.h"

uint16_t sinwave_cont = 0;
#define   __BUFLEN  360
const uint16_t sin_wave[__BUFLEN] /* 正弦波数据 */
              ={0x0800, 0x0823, 0x0847, 0x086B, 0x088E, 0x08B2, 0x08D6, 0x08F9,
                0x091C, 0x0940, 0x0963, 0x0986, 0x09A9, 0x09CC, 0x09EF, 0x0A11,
                0x0A34, 0x0A56, 0x0A78, 0x0A9A, 0x0ABC, 0x0ADD, 0x0AFF, 0x0B20,
                0x0B40, 0x0B61, 0x0B81, 0x0BA1, 0x0BC1, 0x0BE0, 0x0BFF, 0x0C1E,
                0x0C3D, 0x0C5B, 0x0C78, 0x0C96, 0x0CB3, 0x0CD0, 0x0CEC, 0x0D08,
                0x0D24, 0x0D3F, 0x0D5A, 0x0D74, 0x0D8E, 0x0DA7, 0x0DC0, 0x0DD9,
                0x0DF1, 0x0E09, 0x0E20, 0x0E37, 0x0E4D, 0x0E63, 0x0E78, 0x0E8D,
                0x0EA1, 0x0EB5, 0x0EC8, 0x0EDB, 0x0EED, 0x0EFE, 0x0F0F, 0x0F20,
                0x0F30, 0x0F3F, 0x0F4E, 0x0F5C, 0x0F6A, 0x0F77, 0x0F84, 0x0F8F,
                0x0F9B, 0x0FA6, 0x0FB0, 0x0FB9, 0x0FC2, 0x0FCB, 0x0FD2, 0x0FD9,
                0x0FE0, 0x0FE6, 0x0FEB, 0x0FF0, 0x0FF4, 0x0FF7, 0x0FFA, 0x0FFC,
                0x0FFE, 0x0FFF, 0x0FFF, 0x0FFF, 0x0FFE, 0x0FFC, 0x0FFA, 0x0FF7,
                0x0FF4, 0x0FF0, 0x0FEB, 0x0FE6, 0x0FE0, 0x0FD9, 0x0FD2, 0x0FCB,
                0x0FC2, 0x0FB9, 0x0FB0, 0x0FA6, 0x0F9B, 0x0F8F, 0x0F84, 0x0F77,
                0x0F6A, 0x0F5C, 0x0F4E, 0x0F3F, 0x0F30, 0x0F20, 0x0F0F, 0x0EFE,
                0x0EED, 0x0EDB, 0x0EC8, 0x0EB5, 0x0EA1, 0x0E8D, 0x0E78, 0x0E63,
                0x0E4D, 0x0E37, 0x0E20, 0x0E09, 0x0DF1, 0x0DD9, 0x0DC0, 0x0DA7,
                0x0D8E, 0x0D74, 0x0D5A, 0x0D3F, 0x0D24, 0x0D08, 0x0CEC, 0x0CD0,
                0x0CB3, 0x0C96, 0x0C78, 0x0C5B, 0x0C3D, 0x0C1E, 0x0BFF, 0x0BE0,
                0x0BC1, 0x0BA1, 0x0B81, 0x0B61, 0x0B40, 0x0B20, 0x0AFF, 0x0ADD,
                0x0ABC, 0x0A9A, 0x0A78, 0x0A56, 0x0A34, 0x0A11, 0x09EF, 0x09CC,
                0x09A9, 0x0986, 0x0963, 0x0940, 0x091C, 0x08F9, 0x08D6, 0x08B2,
                0x088E, 0x086B, 0x0847, 0x0823, 0x0800, 0x07DC, 0x07B8, 0x0794,
                0x0771, 0x074D, 0x0729, 0x0706, 0x06E3, 0x06BF, 0x069C, 0x0679,
                0x0656, 0x0633, 0x0610, 0x05EE, 0x05CB, 0x05A9, 0x0587, 0x0565,
                0x0543, 0x0522, 0x0500, 0x04DF, 0x04BF, 0x049E, 0x047E, 0x045E,
                0x043E, 0x041F, 0x0400, 0x03E1, 0x03C2, 0x03A4, 0x0387, 0x0369,
                0x034C, 0x032F, 0x0313, 0x02F7, 0x02DB, 0x02C0, 0x02A5, 0x028B,
                0x0271, 0x0258, 0x023F, 0x0226, 0x020E, 0x01F6, 0x01DF, 0x01C8,
                0x01B2, 0x019C, 0x0187, 0x0172, 0x015E, 0x014A, 0x0137, 0x0124,
                0x0112, 0x0101, 0x00F0, 0x00DF, 0x00CF, 0x00C0, 0x00B1, 0x00A3,
                0x0095, 0x0088, 0x007B, 0x0070, 0x0064, 0x0059, 0x004F, 0x0046,
                0x003D, 0x0034, 0x002D, 0x0026, 0x001F, 0x0019, 0x0014, 0x000F,
                0x000B, 0x0008, 0x0005, 0x0003, 0x0001, 0x0000, 0x0000, 0x0000,
                0x0001, 0x0003, 0x0005, 0x0008, 0x000B, 0x000F, 0x0014, 0x0019,
                0x001F, 0x0026, 0x002D, 0x0034, 0x003D, 0x0046, 0x004F, 0x0059,
                0x0064, 0x0070, 0x007B, 0x0088, 0x0095, 0x00A3, 0x00B1, 0x00C0,
                0x00CF, 0x00DF, 0x00F0, 0x0101, 0x0112, 0x0124, 0x0137, 0x014A,
                0x015E, 0x0172, 0x0187, 0x019C, 0x01B2, 0x01C8, 0x01DF, 0x01F6,
                0x020E, 0x0226, 0x023F, 0x0258, 0x0271, 0x028B, 0x02A5, 0x02C0,
                0x02DB, 0x02F7, 0x0313, 0x032F, 0x034C, 0x0369, 0x0387, 0x03A4,
                0x03C2, 0x03E1, 0x0400, 0x041F, 0x043E, 0x045E, 0x047E, 0x049E,
                0x04BF, 0x04DF, 0x0500, 0x0522, 0x0543, 0x0565, 0x0587, 0x05A9,
                0x05CB, 0x05EE, 0x0610, 0x0633, 0x0656, 0x0679, 0x069C, 0x06BF,
                0x06E3, 0x0706, 0x0729, 0x074D, 0x0771, 0x0794, 0x07B8, 0x07DC};

/**
 * \brief DAC 引脚和时钟初始化
 */
void  __dac_init (void)
{
    /* 配置PIOE_30为DAC0_OUT功能                 */
    am_gpio_pin_cfg (PIOE_30,PIOE_30_DAC0_OUT);

    /* 开启DAC时钟                               */
    amhw_sim_periph_clock_enable(AMHW_SIM_SCGC_DAC0);
}

/**
 * \brief DAC 中断服务函数
 */
void __dac_int (void* p_arg)
{
    /* 读取底指针中断清除*/
    if(amhw_dac_bufint_flag_get(AMHW_DAC0,AMHW_DAC_BUF_FLAG_START)){
       amhw_dac_bufint_flag_clr(AMHW_DAC0,AMHW_DAC_BUF_FLAG_START);
       amhw_dac_buf_val_set(AMHW_DAC0,1,1,(uint16_t *)(sin_wave+sinwave_cont));

    }
    /* 读取顶指针中断清除*/
    if(amhw_dac_bufint_flag_get(AMHW_DAC0,AMHW_DAC_BUF_FLAG_UPPER)){
       amhw_dac_bufint_flag_clr(AMHW_DAC0,AMHW_DAC_BUF_FLAG_UPPER);
       amhw_dac_buf_val_set(AMHW_DAC0,0,1,(uint16_t *)(sin_wave+sinwave_cont));

      }
    sinwave_cont ++;
    if(sinwave_cont>=__BUFLEN){
        sinwave_cont = 0;
    }
}

/**
 * \brief 主函数入口
 */
int main (void)
{
    /**
     * \brief DAC 缓存区功能配置结构体定义
     */
    amhw_dac_buffer_config_t dac_buf_cfg={
        .buffer_enable    = TRUE,                   /* 使能BUF功能            */
        .trig_mode        = AMHW_DAC_TRG_SOFT,      /* 软件触发               */
        .start_int_enable = TRUE,                   /* 缓冲读取底指针使能     */
        .upper_int_enable = TRUE,                   /* 缓冲读取顶指针中断使能 */
        .dma_enable       = FALSE,                  /* 禁止DMA功能            */
        .buf_mode         = AMHW_DAC_BUFMODE_NORMAL,/* 缓存区模式为正常模式   */
        .upperidx         = 1                       /* 缓存区上限为1          */
    };

    /* 板级初始化 */
    am_board_init();
    /* DAC引脚时钟初始化 */
    __dac_init();
    /* DAC数据缓存区初始化 */
    amhw_dac_dat_buf_init(AMHW_DAC0,&dac_buf_cfg);

    /* DAC中断链接函数 */
    am_int_connect(INUM_DAC0, __dac_int, NULL);
    am_int_enable(INUM_DAC0);

    /* 使能DAC功能 */
    amhw_dac_enable(AMHW_DAC0);

    /* 设置DAC缓存区的值 */
    amhw_dac_buf_val_set(AMHW_DAC0,0,2,(uint16_t*)(sin_wave+sinwave_cont));
    sinwave_cont+=2;

    while (1) {
    /* 软件触发DAC转换功能 */
    amhw_dac_soft_trg_enable(AMHW_DAC0);

    }

}

/** [src_hw_dac_buf_int] */

/* end of file */











